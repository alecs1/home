/*! follow-ui-concept-module - version: 0.2.13 - 06-08-2014, 9:34:42 AM
http://git.svc.ft.com:9080/summary/?r=strategic-products/follow-concept-ui-module.git
* Copyright (c) 2014, THE FINANCIAL TIMES LTD. All rights reserved. Laurent Muchacho;
*/
!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};b[g][0].call(j.exports,function(a){var c=b[g][1][a];return e(c?c:a)},j,j.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a){"use strict";var b=a("./main.js");window.follow=b,function(){function a(){FT&&FT.$&&FT.cookie?FT.$(function(){b.init()}):10>c&&(setTimeout(a,100),c++)}var c=0;a()}()},{"./main.js":2}],2:[function(a,b){"use strict";var c=a("./src/javascript/FollowController.js");b.exports=new c},{"./src/javascript/FollowController.js":3}],3:[function(a,b){"use strict";function c(){this.model=null,this.view=null}var d=a("./app/models/FollowModel.js"),e=a("./app/views/FollowView.js"),f=a("./app/constants"),g=c.prototype;g.init=function(){var a,b=FT.cookie.get("preferencesSwitch")||"prod";"prod"===b?a="":"test"===b?a="test.":"int"===b&&(a="int."),f.urls.personalisation="http://"+a+"personalisation.ft.com/follow/",this.model=new d,this.model.preferencesSwitch=b,this.view=new e(this.model),this.model.init()},g.destroy=function(){this.view.destroy(),this.model.destroy()},b.exports=c},{"./app/constants":4,"./app/models/FollowModel.js":6,"./app/views/FollowView.js":9}],4:[function(a,b){"use strict";var c=a("./urls.js");b.exports={storage:{expire:1},urls:c,labels:{bylineButton:"Author alerts",overlayTitle:"Get Alerts",authorText:{inactive:{description:"Get an email alert for",button:"Start alerts"},active:{description:"Receiving an email alert for",button:"Stop alerts"}},error:"Sorry, this service is temporarily unavailable.",unsubscribeTitle:"Unsubscribe from author alerts",landingPage:{heading:"Unsubscribe from author alerts",switchHeading:"Personalisation environment switcher",noAuthor:"It seems you are not following any authors.",helpPreferencesMessage:'<p class="help">To change your preferences for other FT emails, please <a href="http://nbe.ft.com/">click here</a>.</p>',stopSingleError:"<p>It seems we've been unable to unsubscribe you from author alerts for %%authorName%% at this time. We're sorry for the inconvenience.</p><p>Please try again later.</p><p>If you continue to experience this issue or you'd like assistance, please contact <a href=\"http://aboutus.ft.com/contact-us/\">customer services</a>.</p>",stopAllError:"<p>It seems we've been unable to unsubscribe you from all author alerts at this time. We're sorry for the inconvenience.</p><p>Please try again later.</p><p>If you continue to experience this issue or you'd like assistance, please contact <a href=\"http://aboutus.ft.com/contact-us/\">customer services</a>.</p>",successAllMessage:"You have successfully unsubscribed from email alerts for all authors.",successSingleMessage:"You have unsubscribed from author alerts for %%authorName%%."}}}},{"./urls.js":8}],5:[function(a,b){"use strict";function c(a){d(e,this,[a])}var d=a("./../../libs/inherits.js"),e=a("./../../libs/DataModel.js");c.prototype.get=function(a){var b,c,d=this.data.value?this.data.value.authors:this.data.authors,e=null;if(a){for(b=0,c=d.length;c>b;b++)if(d[b].id===a){e=d[b];break}d=e}return d},b.exports=c},{"./../../libs/DataModel.js":12,"./../../libs/inherits.js":15}],6:[function(a,b){"use strict";function c(){l(n,this),this.following=null,this.authors=null,this.userId=null,this.articleId=null,this.isTouch=null,this.request={follow:null,unfollow:null}}function d(a){a&&a.authors&&a.authors.length>0&&(this.trigger("renderView"),e.call(this,this.userId))}function e(a){this.following.fetch(q.urls.personalisation+"getFollowingIds?userId="+a)}function f(){FT.analytics.siteIntelligence.sendAdditionalTracer("/eventonpage","type=hover&data=followAuthor")}function g(){FT.analytics.siteIntelligence.trackData("followme=true")}function h(a,b){FT.analytics.siteIntelligence.sendAdditionalTracer("/followme",a+"=true&type=author&value="+b)}function i(){}function j(a){this.following.set(a)}var k=a("./../../libs/scope.js"),l=a("./../../libs/inherits.js"),m=a("./../../libs/WebRequest.js"),n=a("./../../libs/EventsController.js"),o=a("./FollowingModel.js"),p=a("./AuthorsModel.js"),q=a("./../constants.js"),r=c.prototype;r.init=function(){this.userId=this.getUserId(),this.setArticleId(),new m({name:"personalisation",retry:!0}),this.request=new m({name:"personalisation_"+this.userId,retry:!0}),this.following=new o({name:"data_ft_following",retry:!1}),this.following.on("change",k(this,function(){this.request.queue.length>0||this.request.inProgress?this.request.on("finished",k(this,function(){this.trigger("renderAuthors"),this.request.off("finished"),this.following.off("change")})):(this.trigger("renderAuthors"),this.following.off("change"))})),this.authors=new p({name:"data_ft_article_author",expire:1,retry:!1}),this.authors.on("change",k(this,d)),this.request.on("success",k(this,j)),this.request.on("error",k(this,i)),this.on("loadFollowing",k(this,e)),this.on("trackEvent",k(this,f)),this.on("trackData",k(this,g)),this.on("sendAdditionalTracer",k(this,h)),this.trigger("initView")},r.destroy=function(){this.authors.destroy(),this.following.destroy(),this.request.destroy()},r.getUserId=function(){var a=this.userId;if(null===a){var b,c,d=FT.cookie.get("FT_U")||"",e=d.replace(/^_|_$/g,"").split("_"),f=e.length;for(c=0;f>c;c+=1)b=e[c],b.indexOf("EID")>-1&&(a=b.split("=")[1])}return a},r.setArticleId=function(a){a=window.FT&&FT.page&&FT.page.metadata?FT.page.metadata.articleUuid:document.body.getAttribute("data-article-uid"),this.articleId=a},r.getAuthors=function(a){this.authors.fetch(q.urls.metadata+"getAuthors/"+a)},r.followAuthor=function(a){var b=this.authors.get(a);this.trigger("sendAdditionalTracer",["follow",b.name]),this.request.jsonp(q.urls.personalisation+"update?userId="+this.userId+"&name="+encodeURI(b.name)+"&id="+a+"&type=authors")},r.unfollowAuthor=function(a){var b=this.authors.data?this.authors.get(a):this.following.get(a);this.trigger("sendAdditionalTracer",["unfollow",b.name]),this.request.jsonp(q.urls.personalisation+"stopFollowing?userId="+this.userId+"&id="+a)},r.isFollowed=function(a){return this.following.get(a)?!0:!1},b.exports=c},{"./../../libs/EventsController.js":13,"./../../libs/WebRequest.js":14,"./../../libs/inherits.js":15,"./../../libs/scope.js":16,"./../constants.js":4,"./AuthorsModel.js":5,"./FollowingModel.js":7}],7:[function(a,b){"use strict";function c(a){d(e,this,[a])}var d=a("./../../libs/inherits.js"),e=a("./../../libs/DataModel.js");c.prototype.get=function(a){var b,c,d=this.__super.get().taxonomies,e=null;if(a){for(b=0,c=d.length;c>b;b+=1)if(d[b].id===a){e=d[b];break}return e}return d},b.exports=c},{"./../../libs/DataModel.js":12,"./../../libs/inherits.js":15}],8:[function(a,b){"use strict";b.exports={app:"http://www.ft-static.com/sp/prod/author_alerts/long/0.2.13/",personalisation:"http://personalisation.ft.com/follow/",metadata:"http://metadata-cache.webservices.ft.com/v1/"}},{}],9:[function(a,b){"use strict";function c(a){this.model=a,k("main.css"),this.byline=d(),this.overlay=null,this.model.on("initView",l(this,this.init)),this.isRendered=!1}function d(){var a=null;return FT.$(".entry-header .entry-guest-author").size()>0?a=FT.$(".entry-header .entry-guest-author"):FT.$(".entry-meta strong").size()>0?a=FT.$(".entry-meta strong"):FT.$(".entry-header .entry-meta").size()>0?a=FT.$(".entry-header .entry-meta"):FT.$(".byline .author_byline").size()>0?a=FT.$(".byline .author_byline"):0===FT.$(".entry-meta.byline").size()&&(a=FT.$(".byline")),a}function e(a){document.location.href=a}function f(){return document.location.href}function g(){this.model.off("renderView"),this.model.articleId?h.call(this):j.call(this)}function h(){var a=this.model.authors.get();return 0===a.length?!1:(this.model.trigger("trackData"),this.byline.append('<a href="javascript:void(0)" class="followOverlayTrigger">'+o.labels.bylineButton+"</a>"),void i.call(this))}function i(){this.overlay=new m(this.model,this.byline),this.model.isTouch?(this.byline.on("click","a.followOverlayTrigger",l(this.overlay,"clickHandler")),document.body.addEventListener("touchstart",l(this.overlay,"bodyClickHandler"),!1)):(this.byline.on("mouseover","a.followOverlayTrigger",l(this.overlay,function(a){this.mouseoutTimer>-1&&clearTimeout(this.mouseoutTimer),this.show(a)})),this.byline.on("mouseout","a.followOverlayTrigger",l(this.overlay,function(){this.mouseoutTimer=setTimeout(l(this,"mouseoutHandler"),500)})))}function j(){k("preferences.css"),this.preferences=new n(this.model,f())}function k(a){var b=document.getElementsByTagName("head")[0],c=document.createElement("link");c.setAttribute("rel","stylesheet"),c.href=o.urls.app+a,b.appendChild(c)}var l=a("./../../libs/scope.js"),m=a("./OverlayView.js"),n=a("./PreferencesView.js"),o=a("./../constants.js");c.prototype.init=function(){this.model.isTouch="ontouchstart"in window||"onmsgesturechange"in window;var a=this.model.articleId,b=this.model.getUserId(),c=f();this.model.on("renderView",l(this,g)),a&&b?(this.model.getAuthors(a),this.model.on("renderOverlay",l(this,i))):c.indexOf("thirdpartywrapper/unsubscribe")>-1&&(b?(this.model.on("renderAuthors",l(this,g)),this.model.trigger("loadFollowing",[b])):e("https://registration.ft.com/registration/barrier/login?location="+c))},c.prototype.destroy=function(){this.byline&&(this.byline.off("mouseover","a.followOverlayTrigger"),this.byline.off("mouseout","a.followOverlayTrigger"),this.byline.find("a.followOverlayTrigger").remove()),this.overlay&&this.overlay.destroy()},b.exports=c},{"./../../libs/scope.js":16,"./../constants.js":4,"./OverlayView.js":10,"./PreferencesView.js":11}],10:[function(a,b){"use strict";function c(a,b){this.model=a,this.container=null,this.authorId=null,this.isOpen=!1,this.isMouseOver=!1,this.mouseoutTimer=-1,d.call(this,b)}function d(a){var b='<div id="followOverlay" style="display:none"><div class="topArrow"></div><div class="innerBox2"><div class="title">'+i.labels.overlayTitle+'<a class="closeOverlay" href="javascript:void(0)"></a></div><div class="authors"></div></div></div>';this.container=FT.$(b),this.model.on("renderAuthors",h(this,e)),a.closest("div").append(this.container),this.container.on("click",".closeOverlay",h(this,"hide")),this.container.on("click",".ft-button",h(this,f)),this.model.isTouch||(this.container.on("mouseover",h(this,function(){this.mouseoutTimer>-1&&clearTimeout(this.mouseoutTimer),this.isMouseOver=!0})),this.container.on("mouseout",h(this,function(){this.isMouseOver=!1,this.mouseoutTimer=setTimeout(h(this,"mouseoutHandler"),500)})))}function e(){for(var a,b=this.model.authors.get(),c="",d=0,e=b.length;e>d;d+=1)a=b[d],c+=g.call(this,a);this.container.find(".authors").append(FT.$(c))}function f(a){var b=$(a.currentTarget),c=!b.hasClass("ft-button-negative"),d=i.labels.authorText[c?"active":"inactive"],e=b.attr("data-author-id");b[c?"addClass":"removeClass"]("ft-button-negative").html(d.button),b.siblings(".description").html(d.description),c?this.model.followAuthor(e):this.model.unfollowAuthor(e)}function g(a){var b,c="";return this.model.isFollowed(a.id)?(b=i.labels.authorText.active,c="ft-button-negative"):b=i.labels.authorText.inactive,'<p><a class="ft-button ft-button-medium '+c+'" href="javascript:void(0)" data-author-id="'+a.id+'">'+b.button+'</a><span class="description">'+b.description+'</span> <span class="author-name">'+a.name+"</span></p>"}var h=a("./../../libs/scope.js"),i=a("./../constants.js"),j=c.prototype;j.destroy=function(){this.container.off(),this.container.remove(),this.container=null},j.clickHandler=function(a){this.isOpen?this.hide():this.show(a)},j.bodyClickHandler=function(a){this.isOpen&&0===FT.$(a.target).closest("#followOverlay").length&&0===FT.$(a.target).closest(".followOverlayTrigger").length&&this.hide()},j.mouseoverHandler=function(a){this.show(a)},j.mouseoutHandler=function(){this.isMouseOver||this.hide()},j.show=function(a){this.isOpen=!0,this.model.trigger("trackEvent");var b=FT.$(a.currentTarget),c=b.position(),d={width:b.outerWidth(),height:b.outerHeight()};this.container.css({top:c.top+18+d.height,left:c.left+d.width/2-this.container.outerWidth()/2}),this.container.fadeIn(50)},j.hide=function(){this.isOpen=!1,this.container.fadeOut()},b.exports=c},{"./../../libs/scope.js":16,"./../constants.js":4}],11:[function(a,b){"use strict";function c(a,b){this.model=a,this.container=null,d.call(this,b),this.all=!1}function d(a){this.subView=j(a),this.container=$(".freestyle").eq(0),"switch"!==this.subView?l.call(this,"<h1>"+s.labels.landingPage.heading+"</h1>"):l.call(this,"<h1>"+s.labels.landingPage.switchHeading+"</h1>");var b=this.model.following.get();0===b.length&&"switch"!==this.subView?l.call(this,'<ul class="authorsList"><li><p>'+s.labels.landingPage.noAuthor+"</p></li></ul>"):(k.call(this,a),this.container.on("click",".unsubscribe",r(this,g)),this.container.on("click",".unsubscribe-all",r(this,h)),this.container.on("click","button.switch",r(this,q)))}function e(a){var b=document.getElementById("authorId_"+a),c=this.model.following.get(a),d=s.labels.landingPage.successSingleMessage.replace("%%authorName%%",c.name);b&&(b=$(b),b.find("p.info").html(d),b.find("button").hide())}function f(){var a=document.querySelector(".unsubscribeAll"),b=s.labels.landingPage.successAllMessage;a&&(a=$(a),a.find("p.info").html(b),a.find("button").hide())}function g(a){var b=$(a.target),c=b.attr("data-authorId");b.hide(),e.call(this,c),i.call(this,c)}function h(){this.all=!0;for(var a=this.model.following.get(),b=0,c=a.length;c>b;b++)e.call(this,a[b].id),i.call(this,a[b].id);f.call(this)}function i(a){{var b=this.model.following.get(a);document.getElementById("authorId_"+b.id)}this.model.unfollowAuthor(a)}function j(a){var b="";return b=a.indexOf("?all=true")>-1?"all":a.indexOf("?authorId=")>-1?"author":a.indexOf("?switch")>-1?"switch":"preferences"}function k(a){var b=$('<ul class="authorsList">');if("all"===this.subView)this.container.append(b),m.call(this,b);else if("author"===this.subView){var c=a.split("authorId=")[1].split("&")[0],d=this.model.following.get(c);this.container.append(b),d?n.call(this,c,b):l.call(this,"<li><p>It seems you are not following this author.</p></li>",b)}else if("preferences"===this.subView)this.container.append(b),b.addClass("preferences"),o.call(this,b),m.call(this,b);else if("switch"===this.subView){var e=this.model.preferencesSwitch;l.call(this,'<ul class="authorsList"><li><p>Personalisation service currently being pointed at <b>'+e+"</b>. Please click the button below to switch the personalisation environment.<p></li></ul>"),b.addClass("ft-list ft-list-plain ft-list-wrapping"),this.container.append(b),p.call(this,b,e)}}function l(a,b){b=b||this.container,b.append(a)}function m(a){l.call(this,'<li class="unsubscribeAll"><p class="info">To confirm that you no longer wish to receive email alerts for any author, please click \'Stop all author alerts\'.</p><button class="ft-button ft-button-medium unsubscribe-all">Stop all author alerts</button>'+s.labels.landingPage.helpPreferencesMessage+"</li>",a)}function n(a,b){var c=this.model.following.get(a),d="";c&&("preferences"===this.subView&&(d='<br><a href="http://www.ft.com/thirdpartywrapper/unsubscribe?authorId='+c.id+'" target="_blank">Launch '+c.name+" stop alert landing page.</a>"),l.call(this,'<li id="authorId_'+c.id+'"><p class="info">To confirm that you no longer wish to receive author alerts for '+c.name+', please click \'Stop alerts\'.</p><button class="ft-button ft-button-medium unsubscribe" data-authorId="'+c.id+'">Stop alerts</button>'+d+s.labels.landingPage.helpPreferencesMessage+"</li>",b))}function o(a){for(var b,c=this.model.following.get(),d=0,e=c.length;e>d;d+=1)b=c[d],n.call(this,b.id,a)}function p(a,b){for(var c,d,e=["int","test","prod"],f=0,g=e.length;g>f;f+=1)c=e[f],d=c===b?" ft-button-negative":"",l.call(this,'<li class="ft-list-item"><button class="switch ft-button ft-button-medium'+d+'" data-target="'+c+'">'+c+"</button></li>",a)}function q(a){var b=$(a.target),c=this.model.preferencesSwitch,d=b.attr("data-target");c!==d&&(FT.cookie.set("preferencesSwitch",d,{expires:100,path:"/"}),document.location.reload())}var r=a("./../../libs/scope.js"),s=a("./../constants.js"),t=c.prototype;t.destroy=function(){},b.exports=c},{"./../../libs/scope.js":16,"./../constants.js":4}],12:[function(a,b){"use strict";function c(a){a=a||{},i(k,this),this.init(a)}function d(a){a=a||this.url,this.url=a,this.request.jsonp(a)}function e(){return this.data}function f(a){this.data=a}function g(a){this.set(a)}var h=a("./scope.js"),i=a("./inherits.js"),j=a("./WebRequest.js"),k=a("./EventsController.js"),l=c.prototype;l.init=function(a){this.data=null,this.storageName=a.name,this.url=a.url,this.request=new j(a),this.request.on("success",h(this,g))},l.destroy=function(){this.data=null,this.storageName=null,this.url=null,this.request.destroy(),this.__super.destroy()},l.fetch=function(a){d.call(this,a)},l.get=function(){return e.call(this)},l.set=function(a){f.call(this,a),this.trigger("change",[a])},b.exports=c},{"./EventsController.js":13,"./WebRequest.js":14,"./inherits.js":15,"./scope.js":16}],13:[function(a,b){"use strict";function c(){this.events=[],this.keys={}}var d=c.prototype;d.destroy=function(){for(var a=0,b=this.events.length;b>a;a+=1)this.events[a]=null;this.events=null,this.keys=null},d.on=function(a,b){var c,d;a&&b&&(c=this.keys[a]||[],d=this.events.push(b),c.push(d-=1),this.keys[a]=c)},d.off=function(a,b){var c,d=this.keys[a];if(d)for(c=d.length-1;c>=0;c-=1)b?b===this.events[d[c]]&&(this.events[d[c]]=null,d.splice(c,1)):(this.events[d[c]]=null,d.splice(c,1))},d.trigger=function(a,b){var c,d,e=this.keys[a];if(e)for(d=e.length,c=0;d>c;c+=1)this.events[e[c]].apply(this,b||[])},d.once=function(){},b.exports=c},{}],14:[function(a,b){"use strict";function c(a){a=a||{},j(k,this),this.init(a)}function d(){try{return localStorage.setItem("TestKey","1"),localStorage.removeItem("TestKey"),!0}catch(a){return!1}}function e(a){"function"==typeof this.ajax&&(this.ajax(a,{dataType:"jsonp",contentType:"application/json; charset=utf-8",crossDomain:!0,jsonpCallback:this.callbackName,error:i(this,h),cache:!0}),this.queue.shift(),this.saveQueue())}function f(a){a&&"success"===a.status?(this.trigger("success",[a]),this.inProgress.tried&&this.sendToSplunk("request_success_after_"+this.inProgress.tried+"_retries",this.inProgress.url),this.inProgress="",this.jsonp(),0===this.queue.length&&(this.clearQueue(),this.trigger("finished"))):(this.trigger("error",[a]),this.inProgress.tried+=1,this.retry&&g(a)&&this.inProgress.tried<l?(this.sendToSplunk("request_failed_try_"+this.inProgress.tried,this.inProgress.url),this.queue.unshift(this.inProgress),this.saveQueue()):(g(a)&&this.inProgress.tried>=l&&this.sendToSplunk("request_completely_failed",this.inProgress.url),this.inProgress=""),this.trigger("finished"))}function g(a){return!a.message||"user is not following this id"!==a.message&&"user has no following list"!==a.message?!0:!1}function h(){this.trigger("error")}var i=a("./scope.js"),j=a("./inherits.js"),k=a("./EventsController.js"),l=6,m=c.prototype;m.init=function(a){this.name=a.name?a.name.replace(/ /g,""):"",this.ajax=function(a){var b=a.prototype.constructor;return function(){b.apply(window,arguments)}}($.ajax),this.callbackName=a.jsonpCallback||this.name+"RequestCallback",a.jsonpCallback||(window[this.callbackName]=i(this,f)),this.inProgress="",this.queue=[],this.retry="undefined"==typeof a.retry?!0:a.retry,this.persistQueue=this.retry&&d(),this.retry?this.loadQueue():this.clearQueue()},m.destroy=function(){this.name=null,this.ajax=null,this.callbackName=null,window[this.callbackName]=null,this.__super.destroy()},m.jsonp=function(a){var b={url:a,tried:0};a&&(this.queue.push(b),this.saveQueue()),!this.inProgress&&this.queue.length>=1&&(this.inProgress=a?b:this.queue[0],e.call(this,this.queue[0].url))},m.saveQueue=function(){this.persistQueue&&localStorage.setItem("data-ft-"+this.name+"-queue",JSON.stringify(this.queue))},m.loadQueue=function(){if(this.persistQueue){var a=localStorage.getItem("data-ft-"+this.name+"-queue");a&&(this.queue=JSON.parse(a),this.jsonp())}},m.clearQueue=function(){this.persistQueue&&localStorage.removeItem("data-ft-"+this.name+"-queue")},m.sendToSplunk=function(a,b){"function"==typeof this.ajax&&this.ajax("http://track.ft.com/log?type=errors&from=follow&message="+a+"&url="+encodeURIComponent(b),{crossDomain:!0,dataType:"jsonp"})},b.exports=c},{"./EventsController.js":13,"./inherits.js":15,"./scope.js":16}],15:[function(a,b){"use strict";function c(a,b,c,f){if("function"!=typeof a)throw e.Super;if(null===b||b instanceof Array||"object"!=typeof b)throw e.context;if(c&&!(c instanceof Array))throw e.params;var g=a.prototype;b.__super=b.__super||{};for(var h in g)if(g.hasOwnProperty(h))if("undefined"==typeof b[h]||f)b[h]=g[h];else{if("undefined"!=typeof b.__super[h])throw'A conflict occured when trying to inherit from "'+h+'"';b.__super[h]=d(b,g[h])}a.apply(b,c||[])}var d=a("./scope.js"),e={Super:"inherits: Super is not of type function.",context:"inherits: context is not of type object.",params:"inherits: params is not of type Array."};c.ERRORS=e,b.exports=c},{"./scope.js":16}],16:[function(a,b){"use strict";b.exports=function(a,b,c){return c=c||[],function(){var d=Array.prototype.slice.call(arguments,0).concat(c);return"string"==typeof b?a[b].apply(a,d):b.apply(a,d)}}},{}]},{},[1]);